# 说明
- NDK（Native Development Kit）
- 只覆盖了基础的底层能力，如C运行时基础库libc、图形库、窗口系统、多媒体、压缩库、面向ArkTS/JS与C跨语言的Node-API等
- Node-API（NAPI）
    - 与Node.js中的Node-API不完全兼容

# N-API 
- Node-API 公开的 API 通常用于创建和操作 JavaScript 值。
- **所有 Node-API 调用都会返回 napi_status 类型的状态代码**。此状态指示 API 调用是成功还是失败。
- **API 的返回值通过 out 参数传递**。
- **所有 JavaScript 值都被抽象为一个名为 napi_value 的不透明类型**。
- 如果出现错误状态代码，可以使用 napi_get_last_error_info 获取附加信息。
- 中文文档: https://nodejs.cn/api/n-api.html
- 英文文档: https://nodejs.org/docs/latest-v12.x/api/n-api.html

# NDK目录
- ～/Applications/DevEco-Studio.app/Contents/sdk/default/openharmony/native
- build目录：**预定义的toolchain脚本文件** 
- build-tools文件夹：放置NDK提供的编译工具
    - cmake 目录，/build-tools/cmake/bin
- llvm文件夹：放置NDK提供的编译器

```
├── build
│   └── cmake
│       ├── ohos.toolchain.cmake
│       └── sdk_native_platforms.cmake
├── build-tools
│   └── cmake
│       ├── bin
│       │   ├── ccmake
│       │   ├── cmake
│       │   ├── cmake-gui
│       │   ├── cpack
│       │   ├── ctest
│       │   └── ninja
├── llvm
```

# NDK工程构建方式有
- 从源码构建
- 使用预构建库构建, 使用已经存在的库
    - https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/build-with-ndk-prebuilts

# 编译
- NDK通过CMake和Ninja编译应用的C/C++代码
- 流程
    - 生成cmake：CMake配置脚本 + build-profile.json5中 externalNativeOptions 参数 + 缓存中的配置
    - 执行cmake
    - 执行Ninja

![alt text](../photo/../photo/image-250810-20250718-8.png)


## ohos.toolchain.cmake
- HarmonyOS NDK默认使用CMake作为构建系统
- 基础配置文件ohos.toolchain.cmake，用于**预定义CMake变量**来简化开发者配置

## 设置 cmake 参数 CMAKE_TOOLCHAIN_FILE 为 ohos.toolchain.cmake
- CMake 的一个内定变量
- 它指定了一个文件，该文件用于设置和配置工具链
- 工具链是一组用于编译、链接和打包代码的工具，如编译器、链接器等
- 因为每个平台或架构可能都有自己的编译器和工具链

```
- OHOS_STL	c++_shared/c++_static
- OHOS_ARCH	armeabi-v7a/arm64-v8a/x86_64
- OHOS_PLATFORM	OHOS，当前只支持HarmonyOS平台
- 最终目的：上述参数最终会控制Clang的交叉编译命令，产生合适的命令参数
    - `--target={arch}-linux-ohos参数，通知编译器生成相应架构下符合HarmonyOS ABI的二进制文件。`
    - `--sysroot={ndk_root}/sysroot参数，告知编译器HarmonyOS系统头文件的所在位置。`
# 设置编译器路径
set(CMAKE_C_COMPILER "/path/to/arm-gcc")
set(CMAKE_CXX_COMPILER "/path/to/arm-g++")
# 设置目标平台和架构
set(CMAKE_SYSTEM_NAME Linux)
set(CMAKE_SYSTEM_PROCESSOR arm)  # aarch64 arm
set(OHOS_ARCH arm64-v8a) 

# 设置路径
set(CMAKE_SYSROOT "${OHOS_SDK_NATIVE}/sysroot")  # 系统根目录
# set find executable programs on the host system path
set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
list(APPEND CMAKE_FIND_ROOT_PATH "${OHOS_SDK_NATIVE}")    
```
